# CQL-to-ELM Translation Conformance Report

Generated by comparing output of our Rust translator against the reference Java translator.

## Test Infrastructure

- **Java Translator**: cqframework/clinical_quality_language (v4.2.0-SNAPSHOT)
- **Rust Translator**: rh cql compile
- **Comparison Script**: `conformance/scripts/compare_translators.py`

## Summary of Differences

### Critical (Semantic Differences)

| Issue | Description | Java Behavior | Our Behavior | Priority |
|-------|-------------|---------------|--------------|----------|
| System functions | System functions like Abs, Ceiling, Floor should be specific ELM types | `{"type": "Abs", ...}` | `{"type": "FunctionRef", "name": "Abs", ...}` | High |
| Negative literals | Negative numbers should be Negate(Literal) | `{"type": "Negate", "operand": {"type": "Literal", "value": "5"}}` | `{"type": "Literal", "value": "-5"}` | High |
| Integer division | Integer division should promote operands to Decimal | Wraps operands in `ToDecimal` | No promotion | Medium |
| Default context | When no context defined, use "Unfiltered" | `"context": "Unfiltered"` | No context field | Medium |

### Structural (Format Differences)

| Issue | Description | Java Behavior | Our Behavior | Priority |
|-------|-------------|---------------|--------------|----------|
| localId | Element IDs for tracking | Not emitted by default | Always emitted | Low |
| locator | Source location | Not emitted by default | Always emitted | Low |
| annotation | Source annotations | Empty array | Populated with `{s:{r:"..."}}` | Low |
| Empty arrays | Empty annotation arrays | Included | Sometimes omitted | Low |

### Parser Limitations

| Feature | Status | Description |
|---------|--------|-------------|
| `^` power operator | ❌ Not supported | Use `Power(x, y)` function instead |
| `predecessor of` | ❌ Not supported | Unary prefix operator |
| `successor of` | ❌ Not supported | Unary prefix operator |
| `minimum Type` | ❌ Not supported | Type-level minimum |
| `maximum Type` | ❌ Not supported | Type-level maximum |

## Test Cases

### ArithmeticTests.cql

**File**: `conformance/test-cases/arithmetic/ArithmeticTests.cql`

| Definition | Status | Notes |
|------------|--------|-------|
| IntegerAdd | ⚠️ | Missing context, extra localId/locator |
| DecimalAdd | ⚠️ | Same |
| IntegerSubtract | ⚠️ | Same |
| IntegerMultiply | ⚠️ | Same |
| IntegerDivide | ❌ | Missing ToDecimal promotion |
| IntegerModulo | ⚠️ | Missing context |
| DecimalDivide | ⚠️ | Missing context |
| IntegerNegate | ❌ | Should be Negate(5), not Literal(-5) |
| DecimalNegate | ❌ | Same |
| IntegerAbs | ❌ | Should be Abs type, not FunctionRef |
| DecimalAbs | ❌ | Same |
| DecimalCeiling | ❌ | Should be Ceiling type, not FunctionRef |
| DecimalFloor | ❌ | Should be Floor type, not FunctionRef |
| DecimalTruncate | ❌ | Should be Truncate type, not FunctionRef |
| DecimalRound | ❌ | Should be Round type, not FunctionRef |
| IntegerPower | ❌ | Should be Power type, not FunctionRef |
| DecimalPower | ❌ | Same |
| DecimalLn | ❌ | Should be Ln type, not FunctionRef |
| DecimalExp | ❌ | Should be Exp type, not FunctionRef |
| DecimalLog | ❌ | Should be Log type, not FunctionRef |

### SimpleTest.cql

**File**: `conformance/test-cases/simple/SimpleTest.cql`

| Definition | Status | Notes |
|------------|--------|-------|
| Patient | ✅ | Implicit patient definition matches |
| TestExpression | ⚠️ | Structure matches, extra localId/locator |

## Implementation Priorities

### High Priority

1. **System function resolution** - Resolve system functions (Abs, Ceiling, etc.) to their specific ELM types
2. **Negative literal handling** - Parse `-5` as `Negate(Literal(5))`

### Medium Priority

3. **Integer division promotion** - Add ToDecimal wrappers for integer division
4. **Default context** - Add "Unfiltered" context when not specified

### Low Priority (Opt-in via Options)

5. **localId emission** - Only emit when annotations enabled
6. **locator emission** - Only emit when locators enabled
7. **Empty arrays** - Include empty annotation arrays

## Running Tests

```bash
# Run single test
cd crates/rh-cql/conformance
python3 scripts/compare_translators.py -f test-cases/simple/SimpleTest.cql

# Run test directory
python3 scripts/compare_translators.py -t simple

# Run all tests
python3 scripts/compare_translators.py -a
```

## Options Testing

The following options need to be tested systematically:

| Option | Java Flag | Our Flag | Tested |
|--------|-----------|----------|--------|
| EnableDateRangeOptimization | `--date-range-optimization` | N/A | ❌ |
| EnableAnnotations | `--annotations` | default on | ❌ |
| EnableLocators | `--locators` | default on | ❌ |
| EnableResultTypes | `--result-types` | N/A | ❌ |
| EnableDetailedErrors | `--detailed-errors` | N/A | ❌ |
| DisableListTraversal | `--disable-list-traversal` | N/A | ❌ |
| DisableListDemotion | `--disable-list-demotion` | default on | ❌ |
| DisableListPromotion | `--disable-list-promotion` | default on | ❌ |
| EnableIntervalDemotion | `--enable-interval-demotion` | N/A | ❌ |
| EnableIntervalPromotion | `--enable-interval-promotion` | N/A | ❌ |
| DisableMethodInvocation | `--disable-method-invocation` | N/A | ❌ |
| RequireFromKeyword | `--require-from-keyword` | N/A | ❌ |
