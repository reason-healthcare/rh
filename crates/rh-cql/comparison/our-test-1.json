{
  "localId": "89",
  "identifier": {
    "id": "ApplicabilityLogic",
    "version": "0.1.0"
  },
  "schemaIdentifier": {
    "id": "urn:hl7-org:elm",
    "version": "r1"
  },
  "usings": {
    "def": [
      {
        "localIdentifier": "System",
        "uri": "urn:hl7-org:elm-types:r1"
      },
      {
        "localIdentifier": "FHIR",
        "uri": "http://hl7.org/fhir",
        "version": "4.0.1"
      }
    ]
  },
  "includes": {
    "def": [
      {
        "localIdentifier": "FHIRHelpers",
        "path": "FHIRHelpers",
        "version": "0.1.0"
      },
      {
        "localIdentifier": "ActiveMethotrexateFeature",
        "path": "ActiveMethotrexateFeatureLogic",
        "version": "0.1.0"
      },
      {
        "localIdentifier": "ActiveSulfasalazineFeature",
        "path": "ActiveSulfasalazineFeatureLogic",
        "version": "0.1.0"
      },
      {
        "localIdentifier": "LastCbcPanelReportDateFeatureLogic",
        "path": "LastCbcPanelReportDateFeatureLogic",
        "version": "0.1.0"
      }
    ]
  },
  "contexts": {
    "def": [
      {
        "name": "Patient"
      }
    ]
  },
  "statements": {
    "def": [
      {
        "localId": "3",
        "name": "Patient",
        "context": "Patient",
        "expression": {
          "type": "SingletonFrom",
          "localId": "2",
          "operand": {
            "type": "Retrieve",
            "localId": "1",
            "dataType": "{http://hl7.org/fhir}Patient",
            "templateId": "http://hl7.org/fhir/StructureDefinition/Patient",
            "include": [],
            "codeFilter": [],
            "dateFilter": [],
            "otherFilter": []
          }
        },
        "annotation": [
          {
            "type": "Annotation",
            "s": {
              "r": "3"
            }
          }
        ]
      },
      {
        "localId": "13",
        "locator": "13:1",
        "name": "On Methotrexate therapy",
        "context": "Patient",
        "accessLevel": "Public",
        "expression": {
          "type": "If",
          "localId": "12",
          "condition": {
            "type": "Exists",
            "localId": "6",
            "operand": {
              "type": "Property",
              "localId": "5",
              "source": {
                "type": "IdentifierRef",
                "localId": "4",
                "name": "ActiveMethotrexateFeature"
              },
              "path": "On Methotrexate"
            }
          },
          "then": {
            "type": "As",
            "localId": "10",
            "operand": {
              "type": "Property",
              "localId": "9",
              "source": {
                "type": "Property",
                "localId": "8",
                "source": {
                  "type": "IdentifierRef",
                  "localId": "7",
                  "name": "ActiveMethotrexateFeature"
                },
                "path": "On Methotrexate"
              },
              "path": "value"
            },
            "asTypeSpecifier": {
              "type": "NamedTypeSpecifier",
              "name": "boolean"
            }
          },
          "else": {
            "type": "Literal",
            "localId": "11",
            "valueType": "{urn:hl7-org:elm-types:r1}Boolean",
            "value": "false"
          }
        },
        "annotation": [
          {
            "type": "Annotation",
            "s": {
              "r": "13"
            }
          }
        ]
      },
      {
        "localId": "23",
        "locator": "19:1",
        "name": "On Sulfasalazine therapy",
        "context": "Patient",
        "accessLevel": "Public",
        "expression": {
          "type": "If",
          "localId": "22",
          "condition": {
            "type": "Exists",
            "localId": "16",
            "operand": {
              "type": "Property",
              "localId": "15",
              "source": {
                "type": "IdentifierRef",
                "localId": "14",
                "name": "ActiveSulfasalazineFeature"
              },
              "path": "On Sulfasalazine"
            }
          },
          "then": {
            "type": "As",
            "localId": "20",
            "operand": {
              "type": "Property",
              "localId": "19",
              "source": {
                "type": "Property",
                "localId": "18",
                "source": {
                  "type": "IdentifierRef",
                  "localId": "17",
                  "name": "ActiveSulfasalazineFeature"
                },
                "path": "On Sulfasalazine"
              },
              "path": "value"
            },
            "asTypeSpecifier": {
              "type": "NamedTypeSpecifier",
              "name": "boolean"
            }
          },
          "else": {
            "type": "Literal",
            "localId": "21",
            "valueType": "{urn:hl7-org:elm-types:r1}Boolean",
            "value": "false"
          }
        },
        "annotation": [
          {
            "type": "Annotation",
            "s": {
              "r": "23"
            }
          }
        ]
      },
      {
        "localId": "27",
        "locator": "25:1",
        "name": "Condition",
        "context": "Patient",
        "accessLevel": "Public",
        "expression": {
          "type": "FunctionRef",
          "localId": "26",
          "name": "First",
          "operand": [
            {
              "type": "Query",
              "localId": "24",
              "source": [
                {
                  "alias": "M",
                  "expression": {
                    "type": "Retrieve",
                    "localId": "25",
                    "dataType": "{http://hl7.org/fhir}Condition",
                    "templateId": "http://hl7.org/fhir/StructureDefinition/Condition",
                    "codeProperty": "code",
                    "include": [],
                    "codeFilter": [],
                    "dateFilter": [],
                    "otherFilter": []
                  }
                }
              ],
              "sort": {
                "by": [
                  {
                    "type": "ByColumn",
                    "direction": "asc",
                    "path": "recordedDate"
                  }
                ]
              }
            }
          ]
        },
        "annotation": [
          {
            "type": "Annotation",
            "s": {
              "r": "27"
            }
          }
        ]
      },
      {
        "localId": "31",
        "locator": "30:1",
        "name": "Timing of Service",
        "context": "Patient",
        "accessLevel": "Public",
        "expression": {
          "type": "Property",
          "localId": "30",
          "source": {
            "type": "Property",
            "localId": "29",
            "source": {
              "type": "ExpressionRef",
              "localId": "28",
              "name": "Condition"
            },
            "path": "recordedDate"
          },
          "path": "value"
        },
        "annotation": [
          {
            "type": "Annotation",
            "s": {
              "r": "31"
            }
          }
        ]
      },
      {
        "localId": "48",
        "locator": "37:1",
        "name": "Missing last CBC result",
        "context": "Patient",
        "accessLevel": "Public",
        "expression": {
          "type": "If",
          "localId": "47",
          "condition": {
            "type": "Exists",
            "localId": "37",
            "operand": {
              "type": "Property",
              "localId": "36",
              "source": {
                "type": "As",
                "localId": "35",
                "operand": {
                  "type": "Property",
                  "localId": "34",
                  "source": {
                    "type": "Property",
                    "localId": "33",
                    "source": {
                      "type": "IdentifierRef",
                      "localId": "32",
                      "name": "LastCbcPanelReportDateFeatureLogic"
                    },
                    "path": "Last CBC Panel Report Date"
                  },
                  "path": "value"
                },
                "asTypeSpecifier": {
                  "type": "NamedTypeSpecifier",
                  "name": "dateTime"
                }
              },
              "path": "value"
            }
          },
          "then": {
            "type": "Before",
            "localId": "45",
            "operand": [
              {
                "type": "As",
                "localId": "41",
                "operand": {
                  "type": "Property",
                  "localId": "40",
                  "source": {
                    "type": "Property",
                    "localId": "39",
                    "source": {
                      "type": "IdentifierRef",
                      "localId": "38",
                      "name": "LastCbcPanelReportDateFeatureLogic"
                    },
                    "path": "Last CBC Panel Report Date"
                  },
                  "path": "value"
                },
                "asTypeSpecifier": {
                  "type": "NamedTypeSpecifier",
                  "name": "dateTime"
                }
              },
              {
                "type": "Subtract",
                "localId": "44",
                "operand": [
                  {
                    "type": "FunctionRef",
                    "localId": "42",
                    "name": "Today"
                  },
                  {
                    "type": "Quantity",
                    "localId": "43",
                    "value": 6.0,
                    "unit": "month"
                  }
                ]
              }
            ]
          },
          "else": {
            "type": "Literal",
            "localId": "46",
            "valueType": "{urn:hl7-org:elm-types:r1}Boolean",
            "value": "true"
          }
        },
        "annotation": [
          {
            "type": "Annotation",
            "s": {
              "r": "48"
            }
          }
        ]
      },
      {
        "localId": "52",
        "locator": "43:1",
        "name": "DEBUG 1 (value)",
        "context": "Patient",
        "accessLevel": "Public",
        "expression": {
          "type": "Property",
          "localId": "51",
          "source": {
            "type": "Property",
            "localId": "50",
            "source": {
              "type": "IdentifierRef",
              "localId": "49",
              "name": "LastCbcPanelReportDateFeatureLogic"
            },
            "path": "Last CBC Panel Report Date"
          },
          "path": "value"
        },
        "annotation": [
          {
            "type": "Annotation",
            "s": {
              "r": "52"
            }
          }
        ]
      },
      {
        "localId": "57",
        "locator": "46:1",
        "name": "DEBUG 2 (value.value)",
        "context": "Patient",
        "accessLevel": "Public",
        "expression": {
          "type": "Property",
          "localId": "56",
          "source": {
            "type": "Property",
            "localId": "55",
            "source": {
              "type": "Property",
              "localId": "54",
              "source": {
                "type": "IdentifierRef",
                "localId": "53",
                "name": "LastCbcPanelReportDateFeatureLogic"
              },
              "path": "Last CBC Panel Report Date"
            },
            "path": "value"
          },
          "path": "value"
        },
        "annotation": [
          {
            "type": "Annotation",
            "s": {
              "r": "57"
            }
          }
        ]
      },
      {
        "localId": "61",
        "locator": "49:1",
        "name": "DEBUG 3 (exists)",
        "context": "Patient",
        "accessLevel": "Public",
        "expression": {
          "type": "Exists",
          "localId": "60",
          "operand": {
            "type": "Property",
            "localId": "59",
            "source": {
              "type": "IdentifierRef",
              "localId": "58",
              "name": "LastCbcPanelReportDateFeatureLogic"
            },
            "path": "Last CBC Panel Report Date"
          }
        },
        "annotation": [
          {
            "type": "Annotation",
            "s": {
              "r": "61"
            }
          }
        ]
      },
      {
        "localId": "67",
        "locator": "52:1",
        "name": "DEBUG 4 (exists value as dateTime)",
        "context": "Patient",
        "accessLevel": "Public",
        "expression": {
          "type": "Exists",
          "localId": "66",
          "operand": {
            "type": "As",
            "localId": "65",
            "operand": {
              "type": "Property",
              "localId": "64",
              "source": {
                "type": "Property",
                "localId": "63",
                "source": {
                  "type": "IdentifierRef",
                  "localId": "62",
                  "name": "LastCbcPanelReportDateFeatureLogic"
                },
                "path": "Last CBC Panel Report Date"
              },
              "path": "value"
            },
            "asTypeSpecifier": {
              "type": "NamedTypeSpecifier",
              "name": "dateTime"
            }
          }
        },
        "annotation": [
          {
            "type": "Annotation",
            "s": {
              "r": "67"
            }
          }
        ]
      },
      {
        "localId": "74",
        "locator": "55:1",
        "name": "DEBUG 5 (exists value as dateTime).value",
        "context": "Patient",
        "accessLevel": "Public",
        "expression": {
          "type": "Exists",
          "localId": "73",
          "operand": {
            "type": "Property",
            "localId": "72",
            "source": {
              "type": "As",
              "localId": "71",
              "operand": {
                "type": "Property",
                "localId": "70",
                "source": {
                  "type": "Property",
                  "localId": "69",
                  "source": {
                    "type": "IdentifierRef",
                    "localId": "68",
                    "name": "LastCbcPanelReportDateFeatureLogic"
                  },
                  "path": "Last CBC Panel Report Date"
                },
                "path": "value"
              },
              "asTypeSpecifier": {
                "type": "NamedTypeSpecifier",
                "name": "dateTime"
              }
            },
            "path": "value"
          }
        },
        "annotation": [
          {
            "type": "Annotation",
            "s": {
              "r": "74"
            }
          }
        ]
      },
      {
        "localId": "81",
        "locator": "62:1",
        "name": "Should order CBC if on Sulfasalazine therapy and missing test",
        "context": "Patient",
        "accessLevel": "Public",
        "expression": {
          "type": "If",
          "localId": "80",
          "condition": {
            "type": "And",
            "localId": "77",
            "operand": [
              {
                "type": "ExpressionRef",
                "localId": "75",
                "name": "Missing last CBC result"
              },
              {
                "type": "ExpressionRef",
                "localId": "76",
                "name": "On Sulfasalazine therapy"
              }
            ]
          },
          "then": {
            "type": "Literal",
            "localId": "78",
            "valueType": "{urn:hl7-org:elm-types:r1}Boolean",
            "value": "true"
          },
          "else": {
            "type": "Literal",
            "localId": "79",
            "valueType": "{urn:hl7-org:elm-types:r1}Boolean",
            "value": "false"
          }
        },
        "annotation": [
          {
            "type": "Annotation",
            "s": {
              "r": "81"
            }
          }
        ]
      },
      {
        "localId": "88",
        "locator": "72:1",
        "name": "Should order CBC if on Methotrexate therapy and missing test",
        "context": "Patient",
        "accessLevel": "Public",
        "expression": {
          "type": "If",
          "localId": "87",
          "condition": {
            "type": "And",
            "localId": "84",
            "operand": [
              {
                "type": "ExpressionRef",
                "localId": "82",
                "name": "Missing last CBC result"
              },
              {
                "type": "ExpressionRef",
                "localId": "83",
                "name": "On Methotrexate therapy"
              }
            ]
          },
          "then": {
            "type": "Literal",
            "localId": "85",
            "valueType": "{urn:hl7-org:elm-types:r1}Boolean",
            "value": "true"
          },
          "else": {
            "type": "Literal",
            "localId": "86",
            "valueType": "{urn:hl7-org:elm-types:r1}Boolean",
            "value": "false"
          }
        },
        "annotation": [
          {
            "type": "Annotation",
            "s": {
              "r": "88"
            }
          }
        ]
      }
    ]
  },
  "annotation": [
    {
      "translatorVersion": "0.1.0",
      "translatorOptions": "DisableListDemotion,DisableListPromotion,EnableAnnotations,EnableLocators"
    }
  ]
}
