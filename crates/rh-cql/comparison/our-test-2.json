{
  "localId": "65",
  "identifier": {
    "id": "LastCbcPanelReportDateFeatureLogic",
    "version": "0.1.0"
  },
  "schemaIdentifier": {
    "id": "urn:hl7-org:elm",
    "version": "r1"
  },
  "usings": {
    "def": [
      {
        "localIdentifier": "System",
        "uri": "urn:hl7-org:elm-types:r1"
      },
      {
        "localIdentifier": "FHIR",
        "uri": "http://hl7.org/fhir",
        "version": "4.0.1"
      }
    ]
  },
  "includes": {
    "def": [
      {
        "localIdentifier": "FHIRHelpers",
        "path": "FHIRHelpers",
        "version": "0.1.0"
      },
      {
        "localIdentifier": "Common",
        "path": "Common",
        "version": "0.1.0"
      }
    ]
  },
  "codeSystems": {
    "def": [
      {
        "name": "CaseFeatureCodes",
        "id": "http://example.org/CodeSystem/CaseFeatureCodes",
        "accessLevel": "Public"
      },
      {
        "name": "LOINC",
        "id": "http://loinc.org",
        "accessLevel": "Public"
      }
    ]
  },
  "codes": {
    "def": [
      {
        "name": "Last CBC Report Date",
        "id": "last-cbc-panel-report-date",
        "accessLevel": "Public",
        "codeSystem": {
          "name": "CaseFeatureCodes"
        }
      },
      {
        "name": "CBC Panel",
        "id": "58410-2",
        "accessLevel": "Public",
        "codeSystem": {
          "name": "LOINC"
        }
      }
    ]
  },
  "contexts": {
    "def": [
      {
        "name": "Patient"
      }
    ]
  },
  "statements": {
    "def": [
      {
        "localId": "3",
        "name": "Patient",
        "context": "Patient",
        "expression": {
          "type": "SingletonFrom",
          "localId": "2",
          "operand": {
            "type": "Retrieve",
            "localId": "1",
            "dataType": "{http://hl7.org/fhir}Patient",
            "templateId": "http://hl7.org/fhir/StructureDefinition/Patient",
            "include": [],
            "codeFilter": [],
            "dateFilter": [],
            "otherFilter": []
          }
        },
        "annotation": [
          {
            "type": "Annotation",
            "s": {
              "r": "3"
            }
          }
        ]
      },
      {
        "localId": "11",
        "locator": "16:1",
        "name": "CBC Reports",
        "context": "Patient",
        "accessLevel": "Public",
        "expression": {
          "type": "Query",
          "localId": "4",
          "source": [
            {
              "alias": "CBCReport",
              "expression": {
                "type": "Retrieve",
                "localId": "5",
                "dataType": "{http://hl7.org/fhir}DiagnosticReport",
                "templateId": "http://hl7.org/fhir/StructureDefinition/DiagnosticReport",
                "codeProperty": "code",
                "codeComparator": "~",
                "codes": {
                  "type": "ToList",
                  "localId": "7",
                  "operand": {
                    "type": "CodeRef",
                    "localId": "6",
                    "name": "CBC Panel"
                  }
                },
                "include": [],
                "codeFilter": [],
                "dateFilter": [],
                "otherFilter": []
              }
            }
          ],
          "where": {
            "type": "Equivalent",
            "localId": "10",
            "operand": [
              {
                "type": "FunctionRef",
                "name": "ToString",
                "libraryName": "FHIRHelpers",
                "operand": [
                  {
                    "type": "Property",
                    "localId": "8",
                    "path": "status",
                    "scope": "CBCReport"
                  }
                ]
              },
              {
                "type": "Literal",
                "localId": "9",
                "valueType": "{urn:hl7-org:elm-types:r1}String",
                "value": "final"
              }
            ]
          }
        },
        "annotation": [
          {
            "type": "Annotation",
            "s": {
              "r": "11"
            }
          }
        ]
      },
      {
        "localId": "15",
        "locator": "20:1",
        "name": "Last CBC report",
        "context": "Patient",
        "accessLevel": "Public",
        "expression": {
          "type": "FunctionRef",
          "localId": "14",
          "name": "First",
          "operand": [
            {
              "type": "Query",
              "localId": "12",
              "source": [
                {
                  "alias": "C",
                  "expression": {
                    "type": "ExpressionRef",
                    "localId": "13",
                    "name": "CBC Reports"
                  }
                }
              ],
              "sort": {
                "by": [
                  {
                    "type": "ByColumn",
                    "direction": "desc",
                    "path": "effective"
                  }
                ]
              }
            }
          ]
        },
        "annotation": [
          {
            "type": "Annotation",
            "s": {
              "r": "15"
            }
          }
        ]
      },
      {
        "localId": "50",
        "locator": "27:1",
        "name": "Last CBC Panel Report Date Inferred",
        "context": "Patient",
        "accessLevel": "Public",
        "expression": {
          "type": "If",
          "localId": "49",
          "condition": {
            "type": "Exists",
            "localId": "17",
            "operand": {
              "type": "ExpressionRef",
              "localId": "16",
              "name": "Last CBC report"
            }
          },
          "then": {
            "type": "Instance",
            "localId": "47",
            "classType": "{http://hl7.org/fhir}Observation",
            "element": [
              {
                "name": "meta",
                "value": {
                  "type": "Instance",
                  "localId": "21",
                  "classType": "{http://hl7.org/fhir}Meta",
                  "element": [
                    {
                      "name": "profile",
                      "value": {
                        "type": "List",
                        "localId": "20",
                        "element": [
                          {
                            "type": "Instance",
                            "localId": "19",
                            "classType": "{http://hl7.org/fhir}canonical",
                            "element": [
                              {
                                "name": "value",
                                "value": {
                                  "type": "Literal",
                                  "localId": "18",
                                  "valueType": "{urn:hl7-org:elm-types:r1}String",
                                  "value": "http://example.org/StructureDefinition/LastCbcPanelReportDateFeature"
                                }
                              }
                            ]
                          }
                        ]
                      }
                    }
                  ]
                }
              },
              {
                "name": "extension",
                "value": {
                  "type": "List",
                  "localId": "32",
                  "element": [
                    {
                      "type": "Instance",
                      "localId": "26",
                      "classType": "{http://hl7.org/fhir}Extension",
                      "element": [
                        {
                          "name": "url",
                          "value": {
                            "type": "Instance",
                            "localId": "23",
                            "classType": "{http://hl7.org/fhir}url",
                            "element": [
                              {
                                "name": "value",
                                "value": {
                                  "type": "Literal",
                                  "localId": "22",
                                  "valueType": "{urn:hl7-org:elm-types:r1}String",
                                  "value": "http://hl7.org/fhir/uv/cpg/StructureDefinition/cpg-instantiatesCaseFeature"
                                }
                              }
                            ]
                          }
                        },
                        {
                          "name": "value",
                          "value": {
                            "type": "Instance",
                            "localId": "25",
                            "classType": "{http://hl7.org/fhir}canonical",
                            "element": [
                              {
                                "name": "value",
                                "value": {
                                  "type": "Literal",
                                  "localId": "24",
                                  "valueType": "{urn:hl7-org:elm-types:r1}String",
                                  "value": "http://example.org/StructureDefinition/LastCbcPanelReportDateFeature"
                                }
                              }
                            ]
                          }
                        }
                      ]
                    },
                    {
                      "type": "Instance",
                      "localId": "31",
                      "classType": "{http://hl7.org/fhir}Extension",
                      "element": [
                        {
                          "name": "url",
                          "value": {
                            "type": "Instance",
                            "localId": "28",
                            "classType": "{http://hl7.org/fhir}url",
                            "element": [
                              {
                                "name": "value",
                                "value": {
                                  "type": "Literal",
                                  "localId": "27",
                                  "valueType": "{urn:hl7-org:elm-types:r1}String",
                                  "value": "http://hl7.org/fhir/uv/cpg/StructureDefinition/cpg-caseFeatureType"
                                }
                              }
                            ]
                          }
                        },
                        {
                          "name": "value",
                          "value": {
                            "type": "Instance",
                            "localId": "30",
                            "classType": "{http://hl7.org/fhir}code",
                            "element": [
                              {
                                "name": "value",
                                "value": {
                                  "type": "Literal",
                                  "localId": "29",
                                  "valueType": "{urn:hl7-org:elm-types:r1}String",
                                  "value": "inferred"
                                }
                              }
                            ]
                          }
                        }
                      ]
                    }
                  ]
                }
              },
              {
                "name": "status",
                "value": {
                  "type": "Instance",
                  "localId": "34",
                  "classType": "{http://hl7.org/fhir}ObservationStatus",
                  "element": [
                    {
                      "name": "value",
                      "value": {
                        "type": "Literal",
                        "localId": "33",
                        "valueType": "{urn:hl7-org:elm-types:r1}String",
                        "value": "final"
                      }
                    }
                  ]
                }
              },
              {
                "name": "effective",
                "value": {
                  "type": "Instance",
                  "localId": "36",
                  "classType": "{http://hl7.org/fhir}dateTime",
                  "element": [
                    {
                      "name": "value",
                      "value": {
                        "type": "FunctionRef",
                        "localId": "35",
                        "name": "Now"
                      }
                    }
                  ]
                }
              },
              {
                "name": "code",
                "value": {
                  "type": "Instance",
                  "localId": "43",
                  "classType": "{http://hl7.org/fhir}CodeableConcept",
                  "element": [
                    {
                      "name": "coding",
                      "value": {
                        "type": "List",
                        "localId": "42",
                        "element": [
                          {
                            "type": "Instance",
                            "localId": "41",
                            "classType": "{http://hl7.org/fhir}Coding",
                            "element": [
                              {
                                "name": "system",
                                "value": {
                                  "type": "Instance",
                                  "localId": "38",
                                  "classType": "{http://hl7.org/fhir}uri",
                                  "element": [
                                    {
                                      "name": "value",
                                      "value": {
                                        "type": "Literal",
                                        "localId": "37",
                                        "valueType": "{urn:hl7-org:elm-types:r1}String",
                                        "value": "http://example.org/CodeSystem/CaseFeatureCodes"
                                      }
                                    }
                                  ]
                                }
                              },
                              {
                                "name": "code",
                                "value": {
                                  "type": "Instance",
                                  "localId": "40",
                                  "classType": "{http://hl7.org/fhir}code",
                                  "element": [
                                    {
                                      "name": "value",
                                      "value": {
                                        "type": "Literal",
                                        "localId": "39",
                                        "valueType": "{urn:hl7-org:elm-types:r1}String",
                                        "value": "last-cbc-panel-report-date"
                                      }
                                    }
                                  ]
                                }
                              }
                            ]
                          }
                        ]
                      }
                    }
                  ]
                }
              },
              {
                "name": "value",
                "value": {
                  "type": "Instance",
                  "localId": "46",
                  "classType": "{http://hl7.org/fhir}dateTime",
                  "element": [
                    {
                      "name": "value",
                      "value": {
                        "type": "Property",
                        "localId": "45",
                        "source": {
                          "type": "ExpressionRef",
                          "localId": "44",
                          "name": "Last CBC report"
                        },
                        "path": "effective"
                      }
                    }
                  ]
                }
              }
            ]
          },
          "else": {
            "type": "Null",
            "localId": "48"
          }
        },
        "annotation": [
          {
            "type": "Annotation",
            "s": {
              "r": "50"
            }
          }
        ]
      },
      {
        "localId": "55",
        "locator": "63:1",
        "name": "Last CBC Panel Report Date Asserted",
        "context": "Patient",
        "accessLevel": "Public",
        "expression": {
          "type": "FunctionRef",
          "localId": "54",
          "name": "MostRecent",
          "libraryName": "Common",
          "operand": [
            {
              "type": "Retrieve",
              "localId": "51",
              "dataType": "{http://hl7.org/fhir}Observation",
              "templateId": "http://hl7.org/fhir/StructureDefinition/Observation",
              "codeProperty": "code",
              "codeComparator": "~",
              "codes": {
                "type": "ToList",
                "localId": "53",
                "operand": {
                  "type": "CodeRef",
                  "localId": "52",
                  "name": "Last CBC Report Date"
                }
              },
              "include": [],
              "codeFilter": [],
              "dateFilter": [],
              "otherFilter": []
            }
          ]
        },
        "annotation": [
          {
            "type": "Annotation",
            "s": {
              "r": "55"
            }
          }
        ]
      },
      {
        "localId": "59",
        "locator": "70:1",
        "name": "Last CBC Panel Report Date",
        "context": "Patient",
        "accessLevel": "Public",
        "expression": {
          "type": "FunctionRef",
          "localId": "58",
          "name": "Coalesce",
          "operand": [
            {
              "type": "ExpressionRef",
              "localId": "56",
              "name": "Last CBC Panel Report Date Asserted"
            },
            {
              "type": "ExpressionRef",
              "localId": "57",
              "name": "Last CBC Panel Report Date Inferred"
            }
          ]
        },
        "annotation": [
          {
            "type": "Annotation",
            "s": {
              "r": "59"
            }
          }
        ]
      },
      {
        "localId": "64",
        "locator": "76:1",
        "name": "Value",
        "context": "Patient",
        "accessLevel": "Public",
        "expression": {
          "type": "Property",
          "localId": "63",
          "source": {
            "type": "As",
            "localId": "62",
            "operand": {
              "type": "Property",
              "localId": "61",
              "source": {
                "type": "ExpressionRef",
                "localId": "60",
                "name": "Last CBC Panel Report Date"
              },
              "path": "value"
            },
            "asTypeSpecifier": {
              "type": "NamedTypeSpecifier",
              "name": "dateTime"
            }
          },
          "path": "value"
        },
        "annotation": [
          {
            "type": "Annotation",
            "s": {
              "r": "64"
            }
          }
        ]
      }
    ]
  },
  "annotation": [
    {
      "translatorVersion": "0.1.0",
      "translatorOptions": "DisableListDemotion,DisableListPromotion,EnableAnnotations,EnableLocators"
    }
  ]
}
